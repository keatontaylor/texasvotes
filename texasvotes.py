#!/usr/bin/python3
from elasticsearch import helpers, Elasticsearch
from ssl import create_default_context
import requests
import datetime
import os
import io
import csv
import string

DOWNLOAD_URL = "https://earlyvoting.texas-election.com/Elections/downloadVoterInfoReport.do"
ELASTIC_URL = "elasticsearch-es-http"
ELASTIC_CREDENTIALS = ('elastic', os.getenv('elastic'))
ELASTIC_CA_FILE = "http-certs/ca.crt"
ELASTIC_INDEX = "texas-votes"

COUNTYMAP = {
    "Anderson": "001",
    "Andrews": "003",
    "Angelina": "005",
    "Aransas": "007",
    "Archer": "009",
    "Armstrong": "011",
    "Atascosa": "013",
    "Austin": "015",
    "Bailey": "017",
    "Bandera": "019",
    "Bastrop": "021",
    "Baylor": "023",
    "Bee": "025",
    "Bell": "027",
    "Bexar": "029",
    "Blanco": "031",
    "Borden": "033",
    "Bosque": "035",
    "Bowie": "037",
    "Brazoria": "039",
    "Brazos": "041",
    "Brewster": "043",
    "Briscoe": "045",
    "Brooks": "047",
    "Brown": "049",
    "Burleson": "051",
    "Burnet": "053",
    "Caldwell": "055",
    "Calhoun": "057",
    "Callahan": "059",
    "Cameron": "061",
    "Camp": "063",
    "Carson": "065",
    "Cass": "067",
    "Castro": "069",
    "Chambers": "071",
    "Cherokee": "073",
    "Childress": "075",
    "Clay": "077",
    "Cochran": "079",
    "Coke": "081",
    "Coleman": "083",
    "Collin": "085",
    "Collingsworth": "087",
    "Colorado": "089",
    "Comal": "091",
    "Comanche": "093",
    "Concho": "095",
    "Cooke": "097",
    "Coryell": "099",
    "Cottle": "101",
    "Crane": "103",
    "Crockett": "105",
    "Crosby": "107",
    "Culberson": "109",
    "Dallam": "111",
    "Dallas": "113",
    "Dawson": "115",
    "Deaf Smith": "117",
    "Delta": "119",
    "Denton": "121",
    "Dewitt": "123",
    "Dickens": "125",
    "Dimmit": "127",
    "Donley": "129",
    "Duval": "131",
    "Eastland": "133",
    "Ector": "135",
    "Edwards": "137",
    "Ellis": "139",
    "El Paso": "141",
    "Erath": "143",
    "Falls": "145",
    "Fannin": "147",
    "Fayette": "149",
    "Fisher": "151",
    "Floyd": "153",
    "Foard": "155",
    "Fort Bend": "157",
    "Franklin": "159",
    "Freestone": "161",
    "Frio": "163",
    "Gaines": "165",
    "Galveston": "167",
    "Garza": "169",
    "Gillespie": "171",
    "Glasscock": "173",
    "Goliad": "175",
    "Gonzales": "177",
    "Gray": "179",
    "Grayson": "181",
    "Gregg": "183",
    "Grimes": "185",
    "Guadalupe": "187",
    "Hale": "189",
    "Hall": "191",
    "Hamilton": "193",
    "Hansford": "195",
    "Hardeman": "197",
    "Hardin": "199",
    "Harris": "201",
    "Harrison": "203",
    "Hartley": "205",
    "Haskell": "207",
    "Hays": "209",
    "Hemphill": "211",
    "Henderson": "213",
    "Hidalgo": "215",
    "Hill": "217",
    "Hockley": "219",
    "Hood": "221",
    "Hopkins": "223",
    "Houston": "225",
    "Howard": "227",
    "Hudspeth": "229",
    "Hunt": "231",
    "Hutchinson": "233",
    "Irion": "235",
    "Jack": "237",
    "Jackson": "239",
    "Jasper": "241",
    "Jeff Davis": "243",
    "Jefferson": "245",
    "Jim Hogg": "247",
    "Jim Wells": "249",
    "Johnson": "251",
    "Jones": "253",
    "Karnes": "255",
    "Kaufman": "257",
    "Kendall": "259",
    "Kenedy": "261",
    "Kent": "263",
    "Kerr": "265",
    "Kimble": "267",
    "King": "269",
    "Kinney": "271",
    "Kleberg": "273",
    "Knox": "275",
    "Lamar": "277",
    "Lamb": "279",
    "Lampasas": "281",
    "Lasalle": "283",
    "Lavaca": "285",
    "Lee": "287",
    "Leon": "289",
    "Liberty": "291",
    "Limestone": "293",
    "Lipscomb": "295",
    "Live Oak": "297",
    "Llano": "299",
    "Loving": "301",
    "Lubbock": "303",
    "Lynn": "305",
    "Mcculloch": "307",
    "Mclennan": "309",
    "Mcmullen": "311",
    "Madison": "313",
    "Marion": "315",
    "Martin": "317",
    "Mason": "319",
    "Matagorda": "321",
    "Maverick": "323",
    "Medina": "325",
    "Menard": "327",
    "Midland": "329",
    "Milam": "331",
    "Mills": "333",
    "Mitchell": "335",
    "Montague": "337",
    "Montgomery": "339",
    "Moore": "341",
    "Morris": "343",
    "Motley": "345",
    "Nacogdoches": "347",
    "Navarro": "349",
    "Newton": "351",
    "Nolan": "353",
    "Nueces": "355",
    "Ochiltree": "357",
    "Oldham": "359",
    "Orange": "361",
    "Palo Pinto": "363",
    "Panola": "365",
    "Parker": "367",
    "Parmer": "369",
    "Pecos": "371",
    "Polk": "373",
    "Potter": "375",
    "Presidio": "377",
    "Rains": "379",
    "Randall": "381",
    "Reagan": "383",
    "Real": "385",
    "Red River": "387",
    "Reeves": "389",
    "Refugio": "391",
    "Roberts": "393",
    "Robertson": "395",
    "Rockwall": "397",
    "Runnels": "399",
    "Rusk": "401",
    "Sabine": "403",
    "San Augustine": "405",
    "San Jacinto": "407",
    "San Patricio": "409",
    "San Saba": "411",
    "Schleicher": "413",
    "Scurry": "415",
    "Shackelford": "417",
    "Shelby": "419",
    "Sherman": "421",
    "Smith": "423",
    "Somervell": "425",
    "Starr": "427",
    "Stephens": "429",
    "Sterling": "431",
    "Stonewall": "433",
    "Sutton": "435",
    "Swisher": "437",
    "Tarrant": "439",
    "Taylor": "441",
    "Terrell": "443",
    "Terry": "445",
    "Throckmorton": "447",
    "Titus": "449",
    "Tom Green": "451",
    "Travis": "453",
    "Trinity": "455",
    "Tyler": "457",
    "Upshur": "459",
    "Upton": "461",
    "Uvalde": "463",
    "Val Verde": "465",
    "Van Zandt": "467",
    "Victoria": "469",
    "Walker": "471",
    "Waller": "473",
    "Ward": "475",
    "Washington": "477",
    "Webb": "479",
    "Wharton": "481",
    "Wheeler": "483",
    "Wichita": "485",
    "Wilbarger": "487",
    "Willacy": "489",
    "Williamson": "491",
    "Wilson": "493",
    "Winkler": "495",
    "Wise": "497",
    "Wood": "499",
    "Yoakum": "501",
    "Young": "503",
    "Zapata": "505",
    "Zavala": "507"
}

headers = {
    'authority': 'earlyvoting.texas-election.com',
    'pragma': 'no-cache',
    'cache-control': 'no-cache',
    'upgrade-insecure-requests': '1',
    'origin': 'https://earlyvoting.texas-election.com',
    'content-type': 'application/x-www-form-urlencoded',
    'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 11_0_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36',
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
    'sec-fetch-site': 'same-origin',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-user': '?1',
    'sec-fetch-dest': 'document',
    'referer': 'https://earlyvoting.texas-election.com/Elections/getEVDetails.do',
    'accept-language': 'en-US,en;q=0.9',
}

## Generate body for post request
yesterday = datetime.date.today() - datetime.timedelta(days=1)
data = {
    'idElection': '44144',
    'selectedDate': f'{yesterday} 00:00:00.0',
    'idTown': ''
}

# Pull Data from SoS Website
r = requests.post(DOWNLOAD_URL,
                  headers=headers,
                  data=data)
buff = io.StringIO(r.text)
reader = csv.DictReader(buff)

## Format data for indexing
voters = []
for row in reader:
    row["DATE"] = datetime.date.today().isoformat()
    row["VOTER_FIRSTNAME"] = row["VOTER_NAME"].split(", ")[1]
    row["VOTER_LASTNAME"] = row["VOTER_NAME"].split(", ")[0]
    row["COUNTY"] = string.capwords(row["COUNTY"])
    row["COUNTY_FIPS"] = "48" + COUNTYMAP[string.capwords(row["COUNTY"])]
    voters.append(row)

## Create Connection to ElasticSearch
es = Elasticsearch(host=ELASTIC_URL, 
                   ssl_context=create_default_context(cafile=ELASTIC_CA_FILE), 
                   http_auth=ELASTIC_CREDENTIALS, 
                   scheme="https")

## Send data to ElasticSearch
helpers.bulk(es, 
             voters,
             chunk_size=5000,
             index=ELASTIC_INDEX)
